{"version":3,"file":"app-alive-stream-C8610wcI.js","sources":["../../../ui/src/ui/app-alive-stream.ts"],"sourcesContent":["/**\n * SSE stream connector to Wybe OS backend.\n *\n * Replaces the 10-second polling of /api/openclaw/cognition with a persistent\n * EventSource connection to /api/openclaw/stream that pushes cognitive-state,\n * gateway-status, and event updates in real-time.\n *\n * Falls back to polling if SSE connection fails.\n */\n\nimport type { CognitionState } from \"./app-view-state.ts\";\n\ntype AliveStreamHost = {\n  settings: { aliveIntelligenceUrl?: string };\n  cognitionState: CognitionState;\n  cognitionLoading: boolean;\n  loadCognition: () => Promise<void>;\n  startCognitionPolling: () => void;\n  stopCognitionPolling: () => void;\n};\n\nlet eventSource: EventSource | null = null;\nlet reconnectTimer: number | null = null;\nlet pollFallbackActive = false;\nconst RECONNECT_DELAY_MS = 3_000;\n\nfunction getStreamUrl(host: AliveStreamHost): string {\n  const base = host.settings.aliveIntelligenceUrl || \"\";\n  return `${base}/api/openclaw/stream`;\n}\n\nexport function startAliveStream(host: AliveStreamHost): void {\n  stopAliveStream(host);\n\n  const url = getStreamUrl(host);\n\n  try {\n    eventSource = new EventSource(url);\n  } catch {\n    // EventSource constructor failed — fall back to polling\n    startPollFallback(host);\n    return;\n  }\n\n  eventSource.addEventListener(\"cognitive-state\", (e: MessageEvent) => {\n    try {\n      const data = JSON.parse(e.data);\n      host.cognitionState = {\n        selfState: data.selfState,\n        stateDescription: data.stateDescription,\n        recentEmotions: host.cognitionState?.recentEmotions ?? [],\n        memoryCount: host.cognitionState?.memoryCount ?? 0,\n        lastInteraction: host.cognitionState?.lastInteraction ?? null,\n        engineStatuses: data.engineStatuses ?? [],\n        recentSignals: data.recentSignals ?? [],\n        innerLifeStream: host.cognitionState?.innerLifeStream ?? [],\n        tick: data.tick,\n      };\n      host.cognitionLoading = false;\n\n      // Update CSS mood variables\n      if (data.selfState) {\n        const hue = 220 + (data.selfState.valence ?? 0) * 30;\n        const sat = 20 + (data.selfState.arousal ?? 0.3) * 30;\n        const el = document.querySelector(\"openclaw-app\");\n        if (el instanceof HTMLElement) {\n          el.style.setProperty(\"--mood-hue\", String(Math.round(hue)));\n          el.style.setProperty(\"--mood-saturation\", `${Math.round(sat)}%`);\n        }\n      }\n    } catch {\n      // Parse error\n    }\n  });\n\n  eventSource.addEventListener(\"keepalive\", () => {\n    // Connection alive\n  });\n\n  eventSource.addEventListener(\"open\", () => {\n    // Connected — stop any poll fallback\n    stopPollFallback(host);\n  });\n\n  eventSource.addEventListener(\"error\", () => {\n    // Connection lost — clean up and schedule reconnect\n    if (eventSource) {\n      eventSource.close();\n      eventSource = null;\n    }\n\n    startPollFallback(host);\n\n    reconnectTimer = window.setTimeout(() => {\n      reconnectTimer = null;\n      startAliveStream(host);\n    }, RECONNECT_DELAY_MS);\n  });\n}\n\nexport function stopAliveStream(host: AliveStreamHost): void {\n  if (eventSource) {\n    eventSource.close();\n    eventSource = null;\n  }\n  if (reconnectTimer != null) {\n    window.clearTimeout(reconnectTimer);\n    reconnectTimer = null;\n  }\n  stopPollFallback(host);\n}\n\nfunction startPollFallback(host: AliveStreamHost): void {\n  if (pollFallbackActive) {\n    return;\n  }\n  pollFallbackActive = true;\n  host.startCognitionPolling();\n}\n\nfunction stopPollFallback(host: AliveStreamHost): void {\n  if (!pollFallbackActive) {\n    return;\n  }\n  pollFallbackActive = false;\n  host.stopCognitionPolling();\n}\n"],"names":["eventSource","reconnectTimer","pollFallbackActive","RECONNECT_DELAY_MS","getStreamUrl","host","startAliveStream","stopAliveStream","url","startPollFallback","e","data","hue","sat","el","stopPollFallback"],"mappings":"AAqBA,IAAIA,EAAkC,KAClCC,EAAgC,KAChCC,EAAqB,GACzB,MAAMC,EAAqB,IAE3B,SAASC,EAAaC,EAA+B,CAEnD,MAAO,GADMA,EAAK,SAAS,sBAAwB,EACrC,sBAChB,CAEO,SAASC,EAAiBD,EAA6B,CAC5DE,EAAgBF,CAAI,EAEpB,MAAMG,EAAMJ,EAAaC,CAAI,EAE7B,GAAI,CACFL,EAAc,IAAI,YAAYQ,CAAG,CACnC,MAAQ,CAENC,EAAkBJ,CAAI,EACtB,MACF,CAEAL,EAAY,iBAAiB,kBAAoBU,GAAoB,CACnE,GAAI,CACF,MAAMC,EAAO,KAAK,MAAMD,EAAE,IAAI,EAe9B,GAdAL,EAAK,eAAiB,CACpB,UAAWM,EAAK,UAChB,iBAAkBA,EAAK,iBACvB,eAAgBN,EAAK,gBAAgB,gBAAkB,CAAA,EACvD,YAAaA,EAAK,gBAAgB,aAAe,EACjD,gBAAiBA,EAAK,gBAAgB,iBAAmB,KACzD,eAAgBM,EAAK,gBAAkB,CAAA,EACvC,cAAeA,EAAK,eAAiB,CAAA,EACrC,gBAAiBN,EAAK,gBAAgB,iBAAmB,CAAA,EACzD,KAAMM,EAAK,IAAA,EAEbN,EAAK,iBAAmB,GAGpBM,EAAK,UAAW,CAClB,MAAMC,EAAM,KAAOD,EAAK,UAAU,SAAW,GAAK,GAC5CE,EAAM,IAAMF,EAAK,UAAU,SAAW,IAAO,GAC7CG,EAAK,SAAS,cAAc,cAAc,EAC5CA,aAAc,cAChBA,EAAG,MAAM,YAAY,aAAc,OAAO,KAAK,MAAMF,CAAG,CAAC,CAAC,EAC1DE,EAAG,MAAM,YAAY,oBAAqB,GAAG,KAAK,MAAMD,CAAG,CAAC,GAAG,EAEnE,CACF,MAAQ,CAER,CACF,CAAC,EAEDb,EAAY,iBAAiB,YAAa,IAAM,CAEhD,CAAC,EAEDA,EAAY,iBAAiB,OAAQ,IAAM,CAEzCe,EAAiBV,CAAI,CACvB,CAAC,EAEDL,EAAY,iBAAiB,QAAS,IAAM,CAEtCA,IACFA,EAAY,MAAA,EACZA,EAAc,MAGhBS,EAAkBJ,CAAI,EAEtBJ,EAAiB,OAAO,WAAW,IAAM,CACvCA,EAAiB,KACjBK,EAAiBD,CAAI,CACvB,EAAGF,CAAkB,CACvB,CAAC,CACH,CAEO,SAASI,EAAgBF,EAA6B,CACvDL,IACFA,EAAY,MAAA,EACZA,EAAc,MAEZC,GAAkB,OACpB,OAAO,aAAaA,CAAc,EAClCA,EAAiB,MAEnBc,EAAiBV,CAAI,CACvB,CAEA,SAASI,EAAkBJ,EAA6B,CAClDH,IAGJA,EAAqB,GACrBG,EAAK,sBAAA,EACP,CAEA,SAASU,EAAiBV,EAA6B,CAChDH,IAGLA,EAAqB,GACrBG,EAAK,qBAAA,EACP"}